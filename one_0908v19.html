<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1927年革命生存游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#D32F2F',
                        secondary: '#1976D2',
                        accent: '#00796B',
                        light: '#F5F7FA',
                        dark: '#263238',
                        neutral: '#9CA3AF', // 灰色作为投票时进度条颜色
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 0 8px rgba(211, 47, 47, 0.5);
            }
            .glow {
                box-shadow: 0 0 15px rgba(211, 47, 47, 0.5);
            }
            .pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            
            /* 革命红色纹理背景 */
            .bg-revolution {
                background-color: #FCF5F5;
                background-image: 
                    radial-gradient(#D32F2F15 2px, transparent 2px),
                    radial-gradient(#D32F2F15 2px, #FCF5F5 2px);
                background-size: 80px 80px;
                background-position: 0 0, 40px 40px;
                position: relative;
            }
            
            .bg-revolution::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d32f2f' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
                pointer-events: none;
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .option-hover {
            transition: all 0.3s ease;
        }
        
        .option-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(211, 47, 47, 0.3);
        }

        .progress-bar {
            transition: width 0.5s ease-in-out;
        }

        /* 打字机效果 */
        .intro-typewriter {
            overflow: hidden;
            white-space: nowrap;
            margin: 0 auto;
            opacity: 0;
        }
        
        .intro-typewriter.typing {
            animation: typing 2s steps(40, end) forwards;
            opacity: 1;
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }
        
        /* 结果描述左对齐 */
        #result-description {
            text-align: left !important;
        }
        
       /* 修改数字人容器高度为3/4显示 */
        .digital-human-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 94%; /* 原177.78%是9:16比例，133.33%约为3/4高度的4:3比例 */
            overflow: hidden;
            border-radius: 8px;
        }

        /* 调整图片显示位置，确保上3/4内容可见 */
        .digital-human-gif, .digital-human-static {
            object-fit: cover; /* 改为cover确保填充容器，只显示上部分 */
            object-position: center top; /* 图片上对齐，显示上半部分 */
        }
        
        .digital-human-static {
            opacity: 0;
            z-index: 1;
        }
        
        .digital-human-static.active {
            opacity: 1;
        }
        
        .digital-human-gif {
            z-index: 2;
        }
        
        .digital-human-gif.hidden {
            opacity: 0;
            z-index: 0;
        }
        
        /* 音频播放提示层 */
        #audio-prompt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 20px;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        
        #audio-prompt-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
    </style>
</head>
<body class="text-dark overflow-x-hidden min-h-screen">
    <!-- 音频播放提示层 -->
    <div id="audio-prompt-overlay">
        <i class="fa fa-volume-up text-6xl mb-6"></i>
        <h2 class="text-2xl md:text-3xl font-bold mb-4">点击开始游戏介绍</h2>
        <p class="mb-8 max-w-md">为了获得更好的体验，请点击下方按钮开始播放语音介绍</p>
        <button id="start-audio-btn" class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-8 rounded-md transition-all duration-300 glow text-lg">开始播放</button>
    </div>

    <!-- 音频元素 -->
    <audio id="audio1" preload="auto">
        <source src="https://chatfiles.tydiczt.com/tdh/tmp_tts/143c44c6e5724e06a50aec5ae837a81a.wav" type="audio/wav">
    </audio>
    <audio id="audio2" preload="none">
        <source src="https://chatfiles.tydiczt.com/tdh/tmp_tts/7ddc18a49ea342ef88b799feeb977afc.wav" type="audio/wav">
    </audio>
    <audio id="audio3" preload="none">
        <source src="https://chatfiles.tydiczt.com/tdh/tmp_tts/cad6e5531b454ef6805c08902c5c2be6.wav" type="audio/wav">
    </audio>
    <!-- 新增语音4：第一关介绍 -->
    <audio id="audio4" preload="auto">
        <source src="https://chatfiles.tydiczt.com/tdh/tmp_tts/b5e454d36c384c9eb980c05aee8ce94d.wav" type="audio/wav">
    </audio>

    <!-- 主容器保持16:9比例 -->
    <div class="relative w-full max-w-1920 mx-auto" style="padding-bottom: 56.25%;">
        <div id="main-bg" class="absolute inset-0 bg-revolution overflow-y-auto">
            <!-- 介绍页面 -->
            <div id="intro-page" class="h-full w-full flex flex-col">
                <!-- 主要内容区 -->
                <main class="flex-1 flex flex-col md:flex-row p-4 md:p-6 gap-4 md:gap-6 items-center justify-center">
                    <!-- 数字人区域 -->
                    <div class="w-full max-w-xs bg-transparent border-none rounded-lg overflow-hidden flex flex-col items-center justify-center relative p-4 md:p-6">
                        <div class="text-center w-full">
                            <h1 class="text-[clamp(1.2rem,3vw,1.8rem)] font-bold text-primary text-shadow mb-6">革命生存游戏</h1>
                            
                            <!-- 数字人GIF和静态图容器 -->
                            <div class="digital-human-container mx-auto mb-6">
                                <!-- GIF图 - 播放14秒后隐藏 -->
                                <img src="https://chatfiles.tydiczt.com/202508/e2dbc386059e0afb44be821f17e0acc5.gif" alt="数字讲解员动态形象" class="digital-human-gif hidden">
                                <!-- 静态图 - 14秒后显示 -->
                                <img src="https://chatfiles.tydiczt.com/202508/dbef9df2af2801c88da190254ba06cd1.png" alt="数字讲解员静态形象" class="digital-human-static">
                            </div>
                            
                            <h3 class="text-xl font-semibold mb-3">数字讲解员</h3>
                            <p class="text-dark/70 text-sm mb-8" id="digital-human-status">准备就绪</p>
                            <!-- 语音重播按钮 -->
                            <button id="replay-speech-btn" class="bg-primary/80 hover:bg-primary text-white font-bold py-3 px-8 rounded-md transition-all duration-300 glow flex items-center gap-2 mx-auto" disabled="">
                                <i class="fa fa-repeat"></i>
                                <span>重播介绍</span>
                            </button>
                            <!-- <div class="absolute bottom-5 left-0 right-0 flex justify-center">
                                <div class="w-32 h-1.5 bg-primary/30 rounded-full overflow-hidden">
                                    <div class="w-1/3 h-full bg-primary rounded-full"></div>
                                </div>
                            </div> -->
                        </div>
                    </div>

                    <!-- 游戏介绍 -->
                    <div class="w-full md:w-2/3 flex flex-col items-center text-center max-w-2xl">
                        <h2 class="text-[clamp(1.5rem,4vw,2.5rem)] font-bold mb-6 md:mb-8 text-primary text-shadow border-b border-primary/30 pb-2 intro-typewriter" data-delay="0">
                            1927年革命生存游戏
                        </h2>
                        
                        <div class="space-y-4 md:space-y-6 text-[clamp(1.1rem,2.5vw,1.4rem)] leading-relaxed">
                            <p class="intro-typewriter" data-delay="1000">假设你是1927年的一名中共党员，大革命失败后，组织派你领导革命。</p>
                            <p class="font-semibold text-primary intro-typewriter" data-delay="3000">你只有2次决策机会，选错一步就可能全军覆没——准备好了吗？</p>
                            
                            <!-- 游戏规则 -->
                            <div class="mt-6 md:mt-8 p-4 md:p-6 bg-white border-l-4 border-primary rounded shadow-md">
                                <h3 class="text-xl font-bold mb-3 md:mb-4">游戏规则</h3>
                                <ul class="list-disc list-inside space-y-2 md:space-y-3 text-left">
                                    <li>点击"开始投票"即可启动集体投票</li>
                                    <li>投票过程中可随时手动选择你的答案，无需等待投票完成</li>
                                    <li>你的选择将直接决定闯关结果</li>
                                    <li>闯关失败可选择返回重新尝试</li>
                                </ul>
                            </div>
                        </div>

                        <!-- 开始游戏按钮 -->
                        <button id="start-btn" class="mt-8 md:mt-10 bg-primary hover:bg-primary/80 text-white font-bold py-3 px-8 rounded-md transition-all duration-300 glow flex items-center gap-2">
                            <span>开始游戏</span>
                            <i class="fa fa-arrow-right"></i>
                        </button>
                    </div>
                </main>
            </div>

            <!-- 第一关页面 -->
            <div id="level1-page" class="h-full w-full flex flex-col hidden">
                <!-- 主要内容区 -->
                <main class="flex-1 p-4 md:p-6 lg:p-10 pb-20 pt-6">
                    <div class="max-w-4xl mx-auto">
                        <!-- 关卡标题 -->
                        <div class="flex items-center gap-3 mb-8 md:mb-12 border-b-2 border-primary/30 pb-4">
                            <i class="fa fa-flag text-primary text-2xl md:text-3xl"></i>
                            <h1 class="text-[clamp(1.8rem,5vw,3rem)] font-bold text-primary text-shadow">第一关：残血开局，往哪儿走？</h1>
                        </div>
                        
                        <p class="text-[clamp(1.1rem,2.5vw,1.5rem)] leading-relaxed mb-6 md:mb-8">
                            1927年，大革命失败后，白色恐怖笼罩全国，党组织遭到严重破坏，革命陷入低潮。作为一名幸存的中共党员，你必须做出正确选择，才能为革命保留火种。
                        </p>
                        
                        <p class="text-[clamp(1.2rem,3vw,1.7rem)] font-semibold text-primary mb-6 md:mb-10">请选择你的行动方向：</p>
                        
                      <!-- 选项列表 -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8 md:mb-12">
                            <!-- 选项A -->
                            <div class="option option-hover bg-white border border-primary/30 rounded-lg p-4 md:p-6 cursor-pointer group shadow-md flex flex-col" data-option="A">
                                <div class="flex items-center gap-3 mb-3 md:mb-4">
                                    <div class="w-10 h-10 md:w-12 md:h-12 rounded-full bg-primary flex items-center justify-center font-bold text-lg md:text-xl text-white">A</div>
                                </div>
                                <p class="text-lg md:text-xl font-bold flex-grow mb-4">秘密联络工人，继续在城市中组织罢工运动，坚持城市中心革命道路。</p>
                                <div class="h-2 bg-light/70 rounded-full overflow-hidden">
                                    <div class="option-progress progress-bar h-full bg-neutral" data-option="A" style="width: 0%"></div>
                                </div>
                                <div class="mt-2 text-right text-sm text-dark/60 option-percent" data-option="A">0%</div>
                            </div>
                            
                            <!-- 选项B -->
                            <div class="option option-hover bg-white border border-primary/30 rounded-lg p-4 md:p-6 cursor-pointer group shadow-md flex flex-col" data-option="B">
                                <div class="flex items-center gap-3 mb-3 md:mb-4">
                                    <div class="w-10 h-10 md:w-12 md:h-12 rounded-full bg-primary flex items-center justify-center font-bold text-lg md:text-xl text-white">B</div>
                                </div>
                                <p class="text-lg md:text-xl font-bold flex-grow mb-4">离开城市，前往农村地区，发动农民群众，建立农村革命根据地，积蓄革命力量。</p>
                                <div class="h-2 bg-light/70 rounded-full overflow-hidden">
                                    <div class="option-progress progress-bar h-full bg-neutral" data-option="B" style="width: 0%"></div>
                                </div>
                                <div class="mt-2 text-right text-sm text-dark/60 option-percent" data-option="B">0%</div>
                            </div>
                            
                            <!-- 选项C -->
                            <div class="option option-hover bg-white border border-primary/30 rounded-lg p-4 md:p-6 cursor-pointer group shadow-md flex flex-col" data-option="C">
                                <div class="flex items-center gap-3 mb-3 md:mb-4">
                                    <div class="w-10 h-10 md:w-12 md:h-12 rounded-full bg-primary flex items-center justify-center font-bold text-lg md:text-xl text-white">C</div>
                                </div>
                                <p class="text-lg md:text-xl font-bold flex-grow mb-4">前往广州，尝试联合国民党左派力量，继续合作进行革命斗争。</p>
                                <div class="h-2 bg-light/70 rounded-full overflow-hidden">
                                    <div class="option-progress progress-bar h-full bg-neutral" data-option="C" style="width: 0%"></div>
                                </div>
                                <div class="mt-2 text-right text-sm text-dark/60 option-percent" data-option="C">0%</div>
                            </div>
                        </div>
                        
                        <!-- 投票按钮区域 -->
                        <div class="text-center">
                            <button id="vote-btn" class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-10 rounded-md transition-all duration-300 glow text-lg flex items-center gap-2 mx-auto mb-6">
                                <i class="fa fa-bar-chart"></i>
                                <span>开始投票</span>
                            </button>
                            
                            <!-- 投票进度 -->
                            <div id="vote-progress-container" class="mt-6 w-full max-w-2xl mx-auto hidden">
                                <div class="flex justify-between mb-2">
                                    <span class="font-medium">投票进行中（可随时选择答案）</span>
                                </div>
                                <div class="h-3 bg-light border border-primary/20 rounded-full overflow-hidden">
                                    <div id="vote-progress-bar" class="progress-bar h-full bg-primary" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>

                <!-- 底部状态栏 -->
                <footer class="bg-white/80 backdrop-blur-sm border-t border-primary/30 py-2 px-4 md:py-3 md:px-6 text-sm text-dark/60 flex justify-between sticky bottom-0 z-10">
                    <button id="back-btn" class="hover:text-primary transition-colors">
                        <i class="fa fa-arrow-left mr-1"></i> 返回
                    </button>
                    <div>第一关 / 共2关</div>
                </footer>
            </div>

            <!-- 结果页面 -->
            <div id="result-page" class="h-full w-full flex flex-col hidden">
                <!-- 主要内容区 -->
                <main class="flex-1 flex flex-col items-center justify-center p-4 md:p-6 text-center overflow-y-auto py-10">
                    <div id="success-icon" class="text-8xl md:text-9xl text-accent mb-6 md:mb-8 hidden">
                        <i class="fa fa-check-circle pulse-slow"></i>
                    </div>
                    <div id="fail-icon" class="text-8xl md:text-9xl text-primary mb-6 md:mb-8 hidden">
                        <i class="fa fa-times-circle pulse-slow"></i>
                    </div>
                    
                    <!-- 标题 -->
                    <h2 class="text-[clamp(2rem,8vw,3.5rem)] font-bold mb-6 md:mb-10" id="result-heading"></h2>
                    
                    <div class="max-w-2xl mx-auto bg-white border border-primary/30 rounded-lg p-6 md:p-8 mb-6 md:mb-10 shadow-lg">
                        <!-- 结果描述文本 -->
                        <p class="text-[clamp(1.1rem,3vw,1.5rem)] leading-relaxed mb-6 md:mb-8" id="result-description"></p>
                        
                        <!-- 投票结果 -->
                        <div class="mt-6 md:mt-8 p-4 md:p-6 bg-light rounded-lg border border-secondary/20">
                            <h3 class="text-xl font-bold mb-4 md:mb-5 text-secondary">投票结果</h3>
                            <p class="text-lg mb-4 md:mb-6" id="user-choice-display"></p>
                            <div id="user-choice-chart" class="space-y-3 md:space-y-4">
                                <!-- 动态显示用户选择的选项数据 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 按钮区域 -->
                    <div class="flex flex-col sm:flex-row gap-4 md:gap-6 mt-2 md:mt-4 mb-8 z-10">
                        <!-- 通用按钮 -->
                        <button id="restart-btn" class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-8 rounded-md transition-all duration-300 glow text-lg min-w-[160px]">
                            重新开始
                        </button>
                        
                        <!-- 成功时显示 -->
                        <button id="next-level-btn" class="bg-accent hover:bg-accent/80 text-white font-bold py-3 px-8 rounded-md transition-all duration-300 text-lg min-w-[160px] hidden">下一关</button>
                        
                        <!-- 失败时显示 -->
                        <button id="return-level-btn" class="bg-secondary hover:bg-secondary/80 text-white font-bold py-3 px-8 rounded-md transition-all duration-300 text-lg min-w-[160px] hidden">
                            <i class="fa fa-arrow-left mr-1"></i> 返回关卡
                        </button>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script>
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化打字机效果
            const introTypewriters = document.querySelectorAll('.intro-typewriter');
            introTypewriters.forEach(element => {
                const delay = element.getAttribute('data-delay') || 0;
                setTimeout(() => {
                    element.classList.add('typing');
                }, parseInt(delay));
            });
        });

        // 页面元素
        const introPage = document.getElementById('intro-page');
        const level1Page = document.getElementById('level1-page');
        const resultPage = document.getElementById('result-page');
        const startBtn = document.getElementById('start-btn');
        const backBtn = document.getElementById('back-btn');
        const voteBtn = document.getElementById('vote-btn');
        const voteProgressContainer = document.getElementById('vote-progress-container');
        const voteProgressBar = document.getElementById('vote-progress-bar');
        const options = document.querySelectorAll('.option');
        const optionProgress = document.querySelectorAll('.option-progress');
        const optionPercent = document.querySelectorAll('.option-percent');
        const replaySpeechBtn = document.getElementById('replay-speech-btn');
        const userChoiceDisplay = document.getElementById('user-choice-display');
        const userChoiceChart = document.getElementById('user-choice-chart');
        const digitalHumanStatus = document.getElementById('digital-human-status');
        const audioPromptOverlay = document.getElementById('audio-prompt-overlay');
        const startAudioBtn = document.getElementById('start-audio-btn');
        
        // 数字人元素
        const digitalHumanGif = document.querySelector('.digital-human-gif');
        const digitalHumanStatic = document.querySelector('.digital-human-static');
        
        // 音频元素
        const audio1 = document.getElementById('audio1');
        const audio2 = document.getElementById('audio2');
        const audio3 = document.getElementById('audio3');
        const audio4 = document.getElementById('audio4'); // 新增音频4
        
        // 结果页面元素
        const resultHeading = document.getElementById('result-heading');
        const resultDescription = document.getElementById('result-description');
        const successIcon = document.getElementById('success-icon');
        const failIcon = document.getElementById('fail-icon');
        const restartBtn = document.getElementById('restart-btn');
        const nextLevelBtn = document.getElementById('next-level-btn');
        const returnLevelBtn = document.getElementById('return-level-btn');
        
        // 投票数据
        let voteData = {
            A: 20,
            B: 70,
            C: 10,
            total: 100
        };
        
        // 选中的选项
        let selectedOption = null;
        
        // 计时器变量
        let voteInterval;
        let voteSeconds = 0;
        const totalVotingTime = 5; // 投票时间为5秒
        let isVoting = false;
        let animationTimer = null; // 数字人动画计时器
        
        // 播放音频函数
        function playAudio(audioElement) {
            // 停止所有正在播放的音频
            audio1.pause();
            audio1.currentTime = 0;
            audio2.pause();
            audio2.currentTime = 0;
            audio3.pause();
            audio3.currentTime = 0;
            audio4.pause(); // 新增：停止音频4
            audio4.currentTime = 0; // 新增：重置音频4
            
            // 播放指定音频并处理可能的错误
            return audioElement.play().then(() => {
                console.log("音频播放成功");
                return true;
            }).catch(error => {
                console.log("音频播放失败:", error);
                alert("音频播放失败，请检查网络连接或尝试刷新页面");
                return false;
            });
        }
        
        // 数字人动画控制函数 - 播放14秒后静止
        function startDigitalHumanAnimation() {
            // 清除之前的计时器
            if (animationTimer) {
                clearTimeout(animationTimer);
            }
            
            // 显示GIF，隐藏静态图
            digitalHumanGif.classList.remove('hidden');
            digitalHumanStatic.classList.remove('active');
            digitalHumanStatus.textContent = "正在讲解...";
            
            // 14秒后切换到静态图
            animationTimer = setTimeout(() => {
                digitalHumanGif.classList.add('hidden');
                digitalHumanStatic.classList.add('active');
                digitalHumanStatus.textContent = "讲解结束";
            }, 12500);
        }
        
        // 初始化播放语音和动画（通过用户交互触发）
        startAudioBtn.addEventListener('click', async () => {
            // 尝试播放音频
            const audioPlayed = await playAudio(audio1);
            if (audioPlayed) {
                // 隐藏提示层 - 添加过渡动画
                audioPromptOverlay.classList.add('hidden');
                // 启动数字人动画
                startDigitalHumanAnimation();
                // 启用重播按钮
                replaySpeechBtn.disabled = false;
                replaySpeechBtn.classList.remove('bg-primary/80');
                replaySpeechBtn.classList.add('bg-primary', 'hover:bg-primary/80');
            }
        });
        
        // 重播语音1和数字人动画
        replaySpeechBtn.addEventListener('click', async () => {
            // 尝试播放音频
            const audioPlayed = await playAudio(audio1);
            if (audioPlayed) {
                // 启动数字人动画
                startDigitalHumanAnimation();
            }
        });
        
        // 开始游戏 - 新增：进入第一关后自动播放语音4
        startBtn.addEventListener('click', async () => {
            introPage.classList.add('hidden');
            level1Page.classList.remove('hidden');
            // 停止所有音频
            audio1.pause();
            audio2.pause();
            audio3.pause();
            
            // 自动播放第一关介绍语音（音频4）
            await playAudio(audio4);
        });
        
        // 返回介绍页
        backBtn.addEventListener('click', () => {
            // 停止投票
            if (isVoting) {
                clearInterval(voteInterval);
                isVoting = false;
            }
            
            // 停止所有音频
            audio1.pause();
            audio2.pause();
            audio3.pause();
            audio4.pause(); // 新增：停止音频4
            
            level1Page.classList.add('hidden');
            introPage.classList.remove('hidden');
            resetVotingState();
        });
        
        // 选项手动点击选择
        options.forEach(option => {
            option.addEventListener('click', () => {
                // 记录选中的选项
                selectedOption = option.getAttribute('data-option');
                
                // 重置所有选项边框
                options.forEach(opt => opt.classList.remove('border-primary', 'glow'));
                options.forEach(opt => opt.classList.add('border-primary/30'));
                
                // 设置当前选项边框
                option.classList.remove('border-primary/30');
                option.classList.add('border-primary', 'glow');
                
                // 进入结果页面
                showResult();
            });
        });
        
        // 开始投票
        voteBtn.addEventListener('click', () => {
            // 隐藏投票按钮，显示进度条
            voteBtn.classList.add('hidden');
            voteProgressContainer.classList.remove('hidden');
            
            // 重置投票数据
            voteData = { A: 0, B: 0, C: 0, total: 0 };
            isVoting = true;
            
            // 开始模拟投票
            startVotingSimulation();
        });
        
        // 模拟投票过程
        function startVotingSimulation() {
            // 重置计时器
            voteSeconds = 0;
            clearInterval(voteInterval);
            
            // 每100毫秒更新一次
            voteInterval = setInterval(() => {
                // 增加时间
                voteSeconds += 0.1;
                
                // 计算当前进度百分比
                const progress = (voteSeconds / totalVotingTime) * 100;
                voteProgressBar.style.width = `${progress}%`;
                
                // 计算当前应该显示的投票比例
                const currentPercent = Math.min(100, Math.round(progress));
                
                // 按比例更新投票数据
                voteData.A = Math.round(20 * currentPercent / 100);
                voteData.B = Math.round(70 * currentPercent / 100);
                voteData.C = Math.round(10 * currentPercent / 100);
                voteData.total = voteData.A + voteData.B + voteData.C;
                
                // 更新显示
                updateVoteDisplay();
                
                // 投票结束
                if (voteSeconds >= totalVotingTime) {
                    clearInterval(voteInterval);
                    isVoting = false;
                    
                    // 确保最终显示正确比例
                    voteData.A = 20;
                    voteData.B = 70;
                    voteData.C = 10;
                    voteData.total = 100;
                    updateVoteDisplay();
                }
            }, 100);
        }
        
        // 更新投票显示
        function updateVoteDisplay() {
            // 更新每个选项的进度
            for (const option in voteData) {
                if (option !== 'total') {
                    const percent = voteData.total > 0 ? (voteData[option] / voteData.total) * 100 : 0;
                    document.querySelector(`.option-progress[data-option="${option}"]`).style.width = `${percent}%`;
                    document.querySelector(`.option-percent[data-option="${option}"]`).textContent = `${Math.round(percent)}%`;
                }
            }
        }
        
        // 显示结果
        function showResult() {
            // 停止音频4（如果正在播放）
            audio4.pause();
            
            // 如果正在投票，停止投票
            if (isVoting) {
                clearInterval(voteInterval);
                isVoting = false;
                
                // 确保显示最终比例
                voteData.A = 20;
                voteData.B = 70;
                voteData.C = 10;
                voteData.total = 100;
                updateVoteDisplay();
            }
            
            // 重置按钮显示状态
            nextLevelBtn.classList.add('hidden');
            returnLevelBtn.classList.add('hidden');
            successIcon.classList.add('hidden');
            failIcon.classList.add('hidden');
            
            // 获取用户选择的文本
            let choiceText = '';
            switch(selectedOption) {
                case 'A': 
                    choiceText = 'A. 潜伏上海'; 
                    break;
                case 'B': 
                    choiceText = 'B. 转战农村'; 
                    break;
                case 'C': 
                    choiceText = 'C. 广州联合'; 
                    break;
            }
            
            // 显示用户选择的结果及其占比
            const userPercent = voteData[selectedOption];
            userChoiceDisplay.textContent = `你的选择：${choiceText}`;
            
            // 根据是否成功决定进度条颜色
            const isSuccess = selectedOption === 'B';
            const progressColor = isSuccess ? 'bg-accent' : 'bg-primary';
            
            userChoiceChart.innerHTML = `
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-medium">${choiceText}</span>
                        <span class="font-medium">${Math.round(userPercent)}%</span>
                    </div>
                    <div class="h-3 bg-light border border-primary/20 rounded-full overflow-hidden">
                        <div class="progress-bar h-full ${progressColor}" style="width: ${userPercent}%"></div>
                    </div>
                </div>
            `;
            
            // 根据用户选择显示不同结果
            if (selectedOption === 'B') {
                // 成功 - 触发语音2
                resultHeading.textContent = "恭喜您闯关成功";
                resultDescription.textContent = "转战农村，建立农村革命根据地是中国革命的正确道路。这一选择使得革命力量得以保存和发展，为后来的胜利奠定了基础。毛泽东同志领导的秋收起义后向井冈山进军，开创了农村包围城市、武装夺取政权的正确道路。";
                successIcon.classList.remove('hidden');
                nextLevelBtn.classList.remove('hidden');
                playAudio(audio2); // 闯关成功触发语音2
            } else {
                // 失败 - 触发语音3（按要求，闯关失败触发对应的语音）
                resultHeading.textContent = "闯关失败";
                if (selectedOption === 'A') {
                    resultDescription.textContent = "在大革命失败后，国民党在城市中力量强大，继续在上海等大城市进行罢工运动风险极大，难以取得成功。历史证明，单纯依靠城市工人运动无法战胜强大的反动势力。";
                } else {
                    resultDescription.textContent = "大革命失败后，国民党右派已经背叛革命，与国民党左派联合难以形成有效力量，且存在极大的安全风险。此时应该独立领导革命，而不是继续寻求与国民党合作。";
                }
                failIcon.classList.remove('hidden');
                returnLevelBtn.classList.remove('hidden');
                playAudio(audio3); // 闯关失败触发语音3
            }
            
            // 确保按钮在视图中可见
            setTimeout(() => {
                const buttons = document.querySelector('#result-page .flex');
                if (buttons) {
                    buttons.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 500);
            
            // 显示结果页面
            level1Page.classList.add('hidden');
            resultPage.classList.remove('hidden');
        }
        
        // 重新开始（回到介绍页）
        restartBtn.addEventListener('click', () => {
            // 停止所有音频
            audio1.pause();
            audio2.pause();
            audio3.pause();
            audio4.pause(); // 新增：停止音频4
            
            // 重置状态
            selectedOption = null;
            resetVotingState();
            
            // 显示音频提示层
            audioPromptOverlay.classList.remove('hidden');
            
            // 重置数字人状态
            digitalHumanGif.classList.add('hidden');
            digitalHumanStatic.classList.remove('active');
            digitalHumanStatus.textContent = "准备就绪";
            replaySpeechBtn.disabled = true;
            replaySpeechBtn.classList.add('bg-primary/80');
            replaySpeechBtn.classList.remove('bg-primary', 'hover:bg-primary/80');
            
            // 返回介绍页
            resultPage.classList.add('hidden');
            introPage.classList.remove('hidden');
            
            // 重新启动打字机效果
            setTimeout(() => {
                const introTypewriters = document.querySelectorAll('.intro-typewriter');
                introTypewriters.forEach(el => {
                    el.classList.remove('typing');
                    setTimeout(() => {
                        const delay = el.getAttribute('data-delay') || 0;
                        setTimeout(() => {
                            el.classList.add('typing');
                        }, parseInt(delay));
                    }, 100);
                });
            }, 300);
        });
        
        // 返回关卡（失败时可回到当前关卡重新选择）
        returnLevelBtn.addEventListener('click', async () => {
            // 停止所有音频
            audio1.pause();
            audio2.pause();
            audio3.pause();
            
            // 只重置选择状态，保留投票进度
            selectedOption = null;
            
            // 重置选项样式
            options.forEach(opt => {
                opt.classList.remove('border-primary', 'glow');
                opt.classList.add('border-primary/30');
            });
            
            // 返回第一关，保留当前投票进度
            resultPage.classList.add('hidden');
            level1Page.classList.remove('hidden');
            
            // 重新播放第一关介绍语音（音频4）
            //await playAudio(audio4);
            
            // 如果之前已经开始投票，继续显示投票进度
            if (voteData.total > 0) {
                voteBtn.classList.add('hidden');
                voteProgressContainer.classList.remove('hidden');
            }
        });
        
        // 下一关按钮
        nextLevelBtn.addEventListener('click', () => {
            // 停止所有音频
            audio1.pause();
            audio2.pause();
            audio3.pause();
            audio4.pause(); // 新增：停止音频4
            
            // 简单处理，实际应用中可以加载第二关内容
            alert('第二关即将开放，敬请期待！');
            restartBtn.click();
        });
        
        // 重置投票状态
        function resetVotingState() {
            // 重置投票按钮和进度条
            voteBtn.classList.remove('hidden');
            voteProgressContainer.classList.add('hidden');
            voteProgressBar.style.width = '0%';
            
            // 重置选项进度和样式
            optionProgress.forEach(progress => progress.style.width = '0%');
            optionPercent.forEach(percent => percent.textContent = '0%');
            options.forEach(opt => {
                opt.classList.remove('border-primary', 'glow');
                opt.classList.add('border-primary/30');
            });
            
            // 重置投票数据
            voteData = { A: 0, B: 0, C: 0, total: 0 };
            voteSeconds = 0;
        }
        
        // 键盘事件：ESC返回主菜单
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (!introPage.classList.contains('hidden') && audioPromptOverlay.classList.contains('hidden')) return;
                
                // 停止投票
                if (isVoting) {
                    clearInterval(voteInterval);
                    isVoting = false;
                }
                
                // 停止所有音频
                audio1.pause();
                audio2.pause();
                audio3.pause();
                audio4.pause(); // 新增：停止音频4
                
                // 重置状态
                resetVotingState();
                selectedOption = null;
                
                // 显示音频提示层
                audioPromptOverlay.classList.remove('hidden');
                
                // 重置数字人状态
                digitalHumanGif.classList.add('hidden');
                digitalHumanStatic.classList.remove('active');
                digitalHumanStatus.textContent = "准备就绪";
                replaySpeechBtn.disabled = true;
                
                // 返回介绍页
                level1Page.classList.add('hidden');
                resultPage.classList.add('hidden');
                introPage.classList.remove('hidden');
                
                // 重新启动打字机效果
                setTimeout(() => {
                    const introTypewriters = document.querySelectorAll('.intro-typewriter');
                    introTypewriters.forEach(el => {
                        el.classList.remove('typing');
                        setTimeout(() => {
                            const delay = el.getAttribute('data-delay') || 0;
                            setTimeout(() => {
                                el.classList.add('typing');
                            }, parseInt(delay));
                        }, 100);
                    });
                }, 300);
            }
        });
    </script>


    </body></html>
